<%= semantic_form_for [:admin, @wash_machine], html: { multipart: true } do |f| %>
  <%= f.inputs do %>
    <%= f.input :code %>
    <%= f.input :address %>
    <%= f.input :province, :collection => Area.provinces,
      :input_html => { :class => :cascade_select, 'data-cascade-target' => 'wash_machine_city_id' } %>
    <%= f.input :city, :collection => (f.object.city ? f.object.city.parent.children : ''),
      :input_html => { :class => :cascade_select, 'data-cascade-target' => 'wash_machine_area_id' } %>
    <%= f.input :area, :collection => (f.object.area ? f.object.area.parent.children : '') %>
    <div>
      <input id="map_keyword" type="text"/>
      <input id="map_search" type="button" value="搜索"/>
    </div>
    <div id="map" style="height: 500px;">
    </div>
    <%= f.input :lat, :input_html => { :readonly => true } %>
    <%= f.input :lon, :input_html => { :readonly => true } %>
    <%= f.input :price %>
  <% end %>
  <%= f.actions %>
<% end %>

<script language="javascript" src="http://webapi.amap.com/maps?v=1.3&key=4daf14fd86b568d2429698650673d9c1"></script>
<script language="javascript">
var map, marker;
//初始化地图对象，加载地图
function map_init(){
  map = new AMap.Map("map",{
    //二维地图显示视口
    view: new AMap.View2D({
      // center:new AMap.LngLat(116.397428,39.90923),//地图中心点
      zoom:13 //地图显示的缩放级别
    })
  });

  if($('#wash_machine_lat').val()){
    var lng = $('#wash_machine_lon').val();
    var lat = $('#wash_machine_lat').val();
    var markerOption = {
      map:map,
      // icon:"http://webapi.amap.com/images/" + (i + 1) + ".png",
      position:new AMap.LngLat(lng, lat),
      draggable:true, //点标记可拖拽
      raiseOnDrag:true,
      cursor:'move'
    };

    marker = new AMap.Marker(markerOption);

    AMap.event.addListener(marker1, "dragend", function(event){
      $('#wash_machine_lat').val(event.lnglat.getLat());
      $('#wash_machine_lon').val(event.lnglat.getLng());
    });

    map1.setFitView();
  }

  $('#map_search').click(function(){
    var keyword = $('#map_keyword').val();
    if(!keyword){
      return false;
    }
    AMap.service(["AMap.PlaceSearch"], function() {
        var MSearch = new AMap.PlaceSearch({ //构造地点查询类
            pageSize:1,
            pageIndex:1,
            city:"全国"
        });
        //关键字查询
        MSearch.search(keyword, function(status, result){
          if(status === 'complete' && result.info === 'OK'){
            var poiArr = result.poiList.pois;
            var resultCount = poiArr.length;
            for (var i = 0; i < resultCount; i++) {
              var lng = poiArr[i].location.getLng();
              var lat = poiArr[i].location.getLat();

              var markerOption = {
                map:map,
                // icon:"http://webapi.amap.com/images/" + (i + 1) + ".png",
                position:new AMap.LngLat(lng, lat),
                draggable:true, //点标记可拖拽
                raiseOnDrag:true,
                cursor:'move'
              };

              $('#wash_machine_lat').val(lat);
              $('#wash_machine_lon').val(lng);

              if(marker){
                marker.setMap(null);
              }

              marker = new AMap.Marker(markerOption);

              AMap.event.addListener(marker1, "dragend", function(event){
                $('#wash_machine_lat').val(event.lnglat.getLat());
                $('#wash_machine_lon').val(event.lnglat.getLng());
              });
            }

            map.setFitView();
          }
        });
    });
    return false;
  });
}

$(function(){
  map_init();
});
</script>

